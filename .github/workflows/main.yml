name: GeoAlerta SAT - Ciclo Completo
permissions:
  contents: write
on:
  schedule:
    - cron: '0 */6 * * *' # Ejecutar cada 6 horas
  workflow_dispatch: # Permite ejecutar manualmente con un bot칩n

jobs:
  run-sat:
    runs-on: ubuntu-latest
    
    steps:
      - name: 游닌 Descargar repositorio
        uses: actions/checkout@v3
        
      - name: 游냀 Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: 游닍 Instalar librer칤as
        run: |
          pip install -r requirements.txt
          
      - name: 游 Generar Puntos Cr칤ticos (Re-entrenamiento)
        env:
          EE_SECRET_JSON: ${{ secrets.EE_SECRET_JSON }} # Inyectamos la llave aqu칤
        run: python generador_puntos.py
        
      - name: 游 Guardar CSV generado (Blindado v2)
        run: |
          # 1. Configurar identidad
          git config --global user.name 'GeoAlerta Bot'
          git config --global user.email 'bot@geoalerta.com'
          
          # 2. GUARDAR CAMBIOS PRIMERO (Esto soluciona el error 128)
          git add puntos_monitoreo.csv
          # Si no hay cambios, el script no falla (|| echo)
          git commit -m "游뱄 Actualizaci칩n autom치tica de puntos cr칤ticos" || echo "丘멆잺 Sin cambios nuevos para guardar"
          
          # 3. SINCRONIZAR (Ahora s칤 podemos hacer rebase porque ya guardamos)
          git pull origin main --rebase
          
          # 4. SUBIR
          git push origin main
          
      - name: 游니 Ejecutar Monitoreo de Alertas (Main)
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }} # Tus secretos de correo
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        run: python main.py
